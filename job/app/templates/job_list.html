<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Portal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <style>
        /* General Theme */
        body {
            background-color: #f8f9fa;
            color: #333;
            padding-bottom: 100px; /* Adjust this value based on the footer height */
        }
        /* Navbar */
        .navbar {
            background-color: #007bff;
        }
        .navbar-brand, .nav-link {
            color: white !important;
        }
        /* Profile Sidebar */
        .profile-sidebar {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background: white;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.2);
            transition: right 0.3s ease-in-out;
            padding: 20px;
            z-index: 1050;
            border-left: 4px solid #007bff;
            text-align: center;
        }
        .profile-header {
            font-weight: bold;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            color: #333;
            cursor: pointer;
        }
        /* Profile Picture */
        .profile-pic-container {
            position: relative;
            width: 180px;
            height: 200px;
            margin: 0 auto;
        }
        .profile-pic {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid #007bff;
            object-fit: cover;
        }
        .edit-icon {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #007bff;
            color: white;
            padding: 5px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }
        /* SVG Default Profile */
        .default-profile {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        .edit-profile-btn, .edit-password-btn {
            margin-top: 15px;
            width: 80%;
        }
        .edit-password-link {
            color: blue;
            cursor: pointer;
        }
        /* Profile Info */
        .profile-info {
            font-size: 1.1rem;
            margin-top: 10px;
            text-align: left;
        }
        .profile-info strong {
            color: #007bff;
        }
        /* Job Table */
        .table-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        /* Job Cards */
.job-card {
    margin-bottom: 20px;
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
}

.job-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.card-body {
    animation: fadeIn 1s ease-in-out;
}/* Add styles for search bar and button spacing */
.input-group .form-control {
    width: 70%;
}

.input-group .btn {
    margin-left: 10px;
}
    </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#">Job Portal</a>
        <div class="ml-auto">
            {% if user.is_authenticated %}
                <a href="#" id="profile-btn" class="btn btn-outline-light me-2" onclick="console.log('Profile button clicked');">
                    <i class="bi bi-person-circle"></i> Profile
                </a>
                <form action="{% url 'logout' %}" method="POST" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Logout</button>
                </form>
            {% else %}
            {% csrf_token %}
                <a href="{% url 'login' %}" class="btn btn-outline-light me-2">Login</a>
                <a href="{% url 'signup' %}" class="btn btn-light">Signup</a>
            {% endif %}
        </div>
    </div>
</nav>

<!-- Profile Sidebar -->
<div id="profile-sidebar" class="profile-sidebar">
    <button class="close-btn">&times;</button>
    <div class="profile-header">User Profile</div>
    <div class="profile-content">
        <div class="profile-pic-container">
            {% if user.profile.image %}
                <img id="profile-pic" src="{{ user.profile.image.url }}" class="profile-pic" alt="Profile Picture">
            {% else %}
                <svg class="default-profile" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="12" fill="lightgray"/>
                    <circle cx="12" cy="8" r="4" fill="gray"/>
                    <path d="M6 20c0-4 2.5-7 6-7s6 3 6 7" fill="gray"/>
                </svg>
            {% endif %}
            <input type="file" id="upload-profile-pic" style="display: none;">
        </div>
        <div class="profile-info mt-3">
            <p><strong>Name:</strong> {{ user.username }}</p>
            <p><strong>Email:</strong> {{ user.email }}</p>
        </div>
        <button class="btn btn-primary edit-profile-btn" id="edit-profile-btn">Edit Profile</button>
        <p class="edit-password-link" id="edit-password-link">Edit Password</p>
    </div>

    <!-- Edit Profile Form -->
    <div id="edit-profile-form" style="display: none;">
        <h3>Edit Profile</h3>
        <form id="profile-update-form">
            {% csrf_token %}
            <div class="mb-3">
                <label for="edit-username" class="form-label">Name</label>
                <input type="text" id="edit-username" class="form-control" name="username" value="{{ user.username }}" required>
            </div>
            <div class="mb-3">
                <label for="edit-email" class="form-label">Email</label>
                <input type="email" id="edit-email" class="form-control" name="email" value="{{ user.email }}" required>
            </div>
            <button type="submit" class="btn btn-primary">Update Information</button>
        </form>
    </div>

    <!-- Edit Password Form -->
    <div id="edit-password-form" style="display: none;">
        <h3>Edit Password</h3>
        <form id="password-update-form">
            {% csrf_token %}
            <div class="mb-3">
                <label for="current-password" class="form-label">Current Password</label>
                <input type="password" id="current-password" class="form-control" name="current_password" required>
            </div>
            <div class="mb-3">
                <label for="new-password" class="form-label">New Password</label>
                <input type="password" id="new-password" class="form-control" name="new_password" required>
            </div>
            <button type="submit" class="btn btn-primary">Update Password</button>
        </form>
    </div>
</div>

<!-- Job List Section -->
<div class="container mt-4">
    <div class="table-container">
        <h2 class="text-center mb-4 text-primary">Job Listings</h2>

        <!-- Search Bar -->
        <div class="input-group mb-3" style="max-width: 500px; margin: auto;">
            <input type="text" id="jobSearch" class="form-control" placeholder="Search for jobs..." style="width: 70%;">
            <button class="btn btn-primary" type="button" id="searchButton" style="margin-left: 10px;">Search</button>
        </div>

        <!-- Job List Section -->
        <div class="row justify-content-center mb-4 mt-4">
            {% for job in jobs %}
            <div class="col-md-4 ">
                <div class="card job-card shadow-lg h-90 border-0 rounded-4 hover:shadow-xl transition border-start border-primary border-4 mb-2 my-2">
                    <div class="card-body d-flex flex-column p-3">
                        <h5 class="card-title fw-bold text-primary">{{ job.Job }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">{{ job.Org }}</h6>
                        <p class="card-text mb-3">
                            <strong>üìç Location:</strong> Bengaluru, Belgaum, Chennai<br>
                            <strong>üí∞ Salary:</strong> ‚Çπ{{ job.Salary }} LPA<br>
                            <strong>üîπ Experience:</strong> 0 - 5 Years
                        </p>
                        <div class="mb-3">
                            <strong>üõ† Skills:</strong>
                            {% for skill in job.Skills %}
                                <span class="badge bg-secondary">{{ skill }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            <strong>üè¢ Type:</strong>
                            <span class="badge bg-info">In Office</span>
                        </div>
                        <p class="text-muted text-truncate" style="max-height: 60px; overflow: hidden;">
                            {{ job.FullDescription }}
                        </p>
                        <div class="mt-auto">
                            {% if job.Job in applied_jobs %}
                                <button class="btn btn-success w-100 fw-bold" disabled>‚úî Applied</button>
                            {% else %}
                                <button class="btn btn-primary w-100 fw-bold apply-btn" data-job-id="{{ job.Job }}">
                                    Apply Now
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function(){
        // Search Filter
        function filterJobs() {
            var value = $("#jobSearch").val().toLowerCase();
            $(".job-card").filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        }
        
        $("#jobSearch").on("keyup", filterJobs);
        $("#searchButton").on("click", filterJobs);
        
        // Profile Sidebar Toggle
        $("#profile-btn").on("click", function() {
            console.log("Profile button clicked"); // Debug log
            $("#profile-sidebar").css("right", "0");
        });
        
        $(document).on("click", function(event) {
            if (!$(event.target).closest("#profile-sidebar, #profile-btn").length) {
                $("#profile-sidebar").css("right", "-350px");
                $("#edit-profile-form, #edit-password-form").hide();
                $(".profile-content").show();
            }
        });

        // Close Button Functionality
        $(".close-btn").on("click", function() {
            $("#profile-sidebar").css("right", "-350px");
            $("#edit-profile-form, #edit-password-form").hide();
            $(".profile-content").show();
        });

        // Edit Profile Button
        $("#edit-profile-btn").on("click", function() {
            $(".profile-content").hide();
            $("#edit-profile-form").show();
        });
        
        // Edit Password Link
        $("#edit-password-link").on("click", function() {
            $(".profile-content").hide();
            $("#edit-password-form").show();
        });
        
        // AJAX Profile Update
        $("#profile-update-form").on("submit", function(e) {
            e.preventDefault();
            var formData = $(this).serialize();
            $.ajax({
                url: "{% url 'update_profile' %}",
                method: "POST",
                data: formData,
                success: function(response) {
                    if (response.success) {
                        location.reload();  // Reload to update profile info
                    } else {
                        alert("Error updating profile: " + response.error);
                    }
                }
            });
        });
        
        // AJAX Password Update
        $("#password-update-form").on("submit", function(e) {
            e.preventDefault();
            var formData = $(this).serialize();
            $.ajax({
                url: "{% url 'update_password' %}",
                method: "POST",
                data: formData,
                success: function(response) {
                    if (response.success) {
                        alert("Password updated successfully!");
                        location.reload();
                    } else {
                        alert("Error updating password: " + response.error);
                    }
                }
            });
        });
        
        // Apply Button Functionality
        $(".apply-btn").on("click", function() {
            var button = $(this);
            var jobId = button.data("job-id");
            
            $.ajax({
                url: "{% url 'toggle_apply_job' %}",
                method: "POST",
                data: {
                    job_id: jobId,
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function(response) {
                    if (response.status === "applied") {
                        button.text("Applied");
                        button.removeClass("btn-primary").addClass("btn-success");
                    } else {
                        button.text("Apply");
                        button.removeClass("btn-success").addClass("btn-primary");
                    }
                },
                error: function() {
                    alert("Error applying for job. Please try again.");
                }
            });
        });
    });
</script>

</body>
</html>
